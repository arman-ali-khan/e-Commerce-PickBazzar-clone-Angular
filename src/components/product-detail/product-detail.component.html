<div class="bg-white">
  <div class="container mx-auto px-4 py-12 lg:py-20">
    @if (product(); as p) {
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Product Image Gallery -->
        <div>
          <div 
            (mousemove)="handleMouseMove($event)"
            class="aspect-square bg-gray-100 rounded-lg overflow-hidden mb-4 group relative">
            <img #zoomImage [ngSrc]="currentImage()" [alt]="p.name" width="800" height="800" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-150">
          </div>
          @if(p.images && p.images.length > 1) {
            <div class="grid grid-cols-5 gap-2">
              @for(image of p.images; track image) {
                <div 
                  (click)="selectImage(image)"
                  class="aspect-square bg-gray-100 rounded-md overflow-hidden cursor-pointer border-2 transition-colors"
                  [class.border-brand]="currentImage() === image"
                  [class.border-transparent]="currentImage() !== image">
                  <img [ngSrc]="image" [alt]="p.name + ' thumbnail'" width="150" height="150" class="w-full h-full object-cover">
                </div>
              }
            </div>
          }
        </div>
        
        <!-- Product Details -->
        <div class="flex flex-col">
          <a routerLink="/" class="text-sm text-brand hover:underline mb-2 inline-block">Back to products</a>
          <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ p.name }}</h1>
          <p class="text-gray-500 mb-4">{{ p.unit }}</p>
          
          <div class="flex items-baseline mb-6">
            <span class="text-brand font-bold text-3xl">{{ currentPrice() | currency }}</span>
            @if (p.originalPrice) {
              <span class="text-gray-400 line-through text-lg ml-3">{{ p.originalPrice | currency }}</span>
            }
          </div>
          
          <!-- Description -->
          <div class="text-gray-600 leading-relaxed mb-6 border-t pt-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Product Details</h3>
            <p class="mb-4">{{ p.shortDescription }}</p>

            @if (p.longDescription && p.longDescription.length > p.shortDescription.length) {
              <div>
                <p class="text-gray-600">
                  @if(isDescriptionExpanded()) {
                    {{ p.longDescription }}
                  } @else {
                    {{ truncatedLongDescription() }}
                  }
                </p>
                @if(isTruncationNeeded()) {
                  <button (click)="toggleDescription()" class="text-brand font-semibold hover:underline mt-2 text-sm">
                    {{ isDescriptionExpanded() ? 'See Less' : 'Read More' }}
                  </button>
                }
              </div>
            }
          </div>

          <!-- Variants -->
          @if (p.variants && p.variants.length > 0) {
            <div class="mb-6 space-y-4">
              @for (variant of p.variants; track variant.type) {
                <div>
                  <h3 class="text-sm font-semibold text-gray-700 mb-2">{{ variant.type }}</h3>
                  <div class="flex flex-wrap gap-2">
                    @for (option of variant.options; track option.name) {
                      <button 
                        (click)="selectVariant(variant.type, option.name)"
                        [class.bg-brand]="selectedVariants()[variant.type] === option.name"
                        [class.text-white]="selectedVariants()[variant.type] === option.name"
                        [class.border-brand]="selectedVariants()[variant.type] === option.name"
                        [class.bg-white]="selectedVariants()[variant.type] !== option.name"
                        [class.text-gray-700]="selectedVariants()[variant.type] !== option.name"
                        [class.border-gray-300]="selectedVariants()[variant.type] !== option.name"
                        class="px-4 py-2 border rounded-md text-sm font-medium transition-colors hover:border-brand">
                        {{ option.name }}
                        @if (option.priceModifier) {
                           <span>(+{{ option.priceModifier | currency }})</span>
                        }
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <div class="w-full max-w-xs mt-auto">
            @if (quantityInCart() === 0) {
              <button 
                (click)="onAddToCart()" 
                [disabled]="!areAllVariantsSelected()"
                class="w-full bg-brand text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center space-x-2 transition-colors duration-300 text-lg"
                [class.hover:bg-brand-dark]="areAllVariantsSelected()"
                [class.opacity-50]="!areAllVariantsSelected()"
                [class.cursor-not-allowed]="!areAllVariantsSelected()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                <span>{{ areAllVariantsSelected() ? 'Add to Cart' : 'Select Options' }}</span>
              </button>
            } @else {
              <div class="flex items-center justify-between bg-brand text-white font-semibold rounded-lg">
                <button (click)="decrement()" class="px-6 py-3 text-2xl hover:bg-brand-dark rounded-l-lg">-</button>
                <span class="px-6 py-3 text-lg font-bold">{{ quantityInCart() }} in cart</span>
                <button (click)="increment()" class="px-6 py-3 text-2xl hover:bg-brand-dark rounded-r-lg">+</button>
              </div>
            }
          </div>
        </div>
      </div>
      
      <!-- Reviews Section -->
      <div class="mt-16 pt-12 border-t">
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Customer Reviews</h2>
        @if (p.reviews && p.reviews.length > 0) {
          <div class="space-y-8">
            @for (review of p.reviews; track review.user + review.comment) {
              <div class="flex">
                <div class="flex-shrink-0 mr-4">
                  <div class="w-12 h-12 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xl font-bold">
                    {{ review.user.charAt(0) }}
                  </div>
                </div>
                <div>
                  <div class="flex items-center mb-1">
                    <h4 class="font-semibold text-gray-800 mr-2">{{ review.user }}</h4>
                     <div class="flex items-center text-yellow-400">
                        @for (star of getStarArray(review.rating); track $index) {
                          <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>
                        }
                        @for (star of getEmptyStarArray(review.rating); track $index) {
                           <svg class="w-4 h-4 fill-current text-gray-300" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>
                        }
                      </div>
                  </div>
                  <p class="text-gray-600">{{ review.comment }}</p>
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="text-gray-500">This product has no reviews yet. Be the first to write one!</p>
        }

        <!-- Write a Review Form -->
        <div class="mt-12 pt-8 border-t">
          <h3 class="text-2xl font-bold text-gray-800 mb-4">Write a Review</h3>
          <form [formGroup]="reviewForm" (ngSubmit)="onSubmitReview()" novalidate class="space-y-4 max-w-xl">
            <div>
              <label for="user" class="block text-sm font-medium text-gray-700">Your Name</label>
              <input type="text" id="user" formControlName="user" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand sm:text-sm px-3 py-2">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Rating</label>
              <div class="mt-1 flex items-center" (mouseleave)="setHoverRating(0)">
                @for (star of [1, 2, 3, 4, 5]; track star) {
                  <svg 
                    (mouseenter)="setHoverRating(star)" 
                    (click)="setRating(star)"
                    class="w-6 h-6 cursor-pointer"
                    [class.text-yellow-400]="star <= (hoveredRating() || selectedRating())"
                    [class.text-gray-300]="star > (hoveredRating() || selectedRating())"
                    fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                }
              </div>
            </div>

            <div>
              <label for="comment" class="block text-sm font-medium text-gray-700">Your Review</label>
              <textarea id="comment" formControlName="comment" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand focus:ring-brand sm:text-sm"></textarea>
            </div>
            
            <button type="submit" [disabled]="reviewForm.invalid" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand hover:bg-brand-dark disabled:bg-gray-300 disabled:cursor-not-allowed">
              Submit Review
            </button>
          </form>
        </div>
      </div>
    } @else {
      <!-- Loading or Not Found State -->
      <div class="text-center py-20">
        <p class="text-xl text-gray-600">Loading product...</p>
      </div>
    }
  </div>
</div>